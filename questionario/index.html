<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Form</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .description {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .question {
            margin-bottom: 30px;
        }

        .question-text {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option:hover {
            border-color: #667eea;
            background-color: #f8f9ff;
        }

        .option input[type="radio"] {
            margin-right: 12px;
            cursor: pointer;
            width: 20px;
            height: 20px;
        }

        .option label {
            cursor: pointer;
            flex: 1;
            font-size: 16px;
            color: #555;
        }

        .option.selected {
            border-color: #667eea;
            background-color: #f0f3ff;
        }

        .slider-container {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background-color: #f8f9ff;
        }

        .slider-wrapper {
            margin: 20px 0;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(to right, #e0e0e0 0%, #667eea 100%);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }

        .slider-value {
            text-align: center;
            font-size: 20px;
            font-weight: 600;
            color: #667eea;
            margin-top: 10px;
        }

        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: transform 0.2s ease;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .result {
            display: none;
            text-align: center;
        }

        .result.show {
            display: block;
        }

        .result h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .result-image {
            max-width: 100%;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .result-description {
            color: #666;
            line-height: 1.8;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .restart-btn {
            background: #f0f0f0;
            color: #333;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .restart-btn:hover {
            background: #e0e0e0;
        }

        .form-section {
            display: block;
        }

        .form-section.hidden {
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div style="padding: 20px 0"><img style="display: grid; margin: 0 auto" src="/img/saichepuoi.jpg" alt=""/></div>
    <div class="form-section" id="formSection">
        <div></div>
        <h1 id="quizTitle"></h1>
        <p class="description" id="quizDescription"></p>

        <form id="quizForm">
            <div id="questionsContainer"></div>
            <button type="submit" class="submit-btn" id="submitBtn">Calcola il risultato</button>
        </form>
    </div>

    <div class="loading" id="loadingSection">
        <div class="spinner"></div>
        <p>Saving your answers...</p>
    </div>

    <div class="result" id="resultSection">
        Fai parte dei:
        <h2 id="resultTitle"></h2>
        <p class="result-description" id="resultDescription"></p>

        <!-- Cartesian Plane -->
        <div id="cartesianPlane" style="margin: 30px 0;">
            <svg width="100%" height="400" viewBox="0 0 500 500" style="border: 1px solid #e0e0e0; border-radius: 10px; background: #f8f9ff;">
                <!-- Grid lines -->
                <line x1="250" y1="0" x2="250" y2="500" stroke="#ddd" stroke-width="1" stroke-dasharray="5,5"/>
                <line x1="0" y1="250" x2="500" y2="250" stroke="#ddd" stroke-width="1" stroke-dasharray="5,5"/>

                <!-- Axes -->
                <line x1="0" y1="250" x2="500" y2="250" stroke="#333" stroke-width="2"/>
                <line x1="250" y1="0" x2="250" y2="500" stroke="#333" stroke-width="2"/>

                <!-- Axis labels -->
                <text x="0" y="270" font-size="14" fill="#667eea" font-weight="600">Individuo</text>
                <text x="430" y="270" font-size="14" fill="#667eea" font-weight="600">Collettivo</text>
                <text x="260" y="30" font-size="14" fill="#667eea" font-weight="600">Cambiamento</text>
                <text x="260" y="490" font-size="14" fill="#667eea" font-weight="600">Status Quo</text>

                <!-- Result point -->
                <circle id="resultPoint" cx="250" cy="250" r="8" fill="#764ba2" stroke="#667eea" stroke-width="3">
                    <animate attributeName="r" from="0" to="8" dur="0.5s" fill="freeze"/>
                </circle>

                <!-- Crosshair lines for the point -->
                <line id="verticalLine" x1="250" y1="0" x2="250" y2="500" stroke="#764ba2" stroke-width="1" stroke-dasharray="3,3" opacity="0.5"/>
                <line id="horizontalLine" x1="0" y1="250" x2="500" y2="250" stroke="#764ba2" stroke-width="1" stroke-dasharray="3,3" opacity="0.5"/>
            </svg>
            <div style="text-align: center; margin-top: 10px; color: #666; font-size: 14px;">
                <span id="coordinatesText">Posizione: (50, 50)</span>
            </div>
        </div>

        <div>
            <button class="restart-btn" onclick="restartQuiz()">Take Quiz Again</button>
        </div>
    </div>
</div>

<script>
    // ===== GOOGLE SHEETS CONFIGURATION =====
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx0NcWLNOLtLO9gyTTxQUXl6II4mKQb5sSl4BG-pTJUs7riZQvY_9H5CanTbsyTLS1IWA/exec';

    // Set to false to disable data collection (for testing)
    const ENABLE_DATA_COLLECTION = true;

    // ===== QUIZ CONFIGURATION =====
    const quizData = {
        title: "Questionario Via Libera",
        description: "",

        // Question type: "radio" or "slider"
        questions: [
            {
                type: "slider",
                text: "Non uso la macchina e credo che troppo spazio cittadino sia dedicato alle auto: sarebbe giusto ridurlo o riconvertirlo.",
                min: 0,
                max: 5,
                defaultValue: 3,
                minLabel: "Per niente",
                maxLabel: "Moltissimo",
                weightX: 1,
                weightY: 0.5
            },
            {
                type: "slider",
                text: "Ridurre le auto è essenziale per il bene del pianeta e combattere la crisi climatica.",
                min: 0,
                max: 5,
                defaultValue: 3,
                minLabel: "Per niente",
                maxLabel: "Moltissimo",
                weightX: 1,
                weightY: 1
            },
            {
                type: "slider",
                text: "Vorrei più verde nel mio quartiere, anche se questo significasse perdere qualche parcheggio.",
                min: 0,
                max: 5,
                defaultValue: 3,
                minLabel: "Per niente",
                maxLabel: "Moltissimo",
                weightX: 0.5,
                weightY: 1
            },
            {
                type: "slider",
                text: "Mi piacerebbe che alcuni spazi oggi dedicati alle auto nel mio quartiere diventassero luoghi di aggregazione o gioco.",
                min: 0,
                max: 5,
                defaultValue: 3,
                minLabel: "Per niente",
                maxLabel: "Moltissimo",
                weightX: 0.5,
                weightY: 0.5
            },
            {
                type: "slider",
                text: "Temo che riconvertire i parcheggi in spazi di aggregazione porterebbe solo rumore e disturbo sotto casa.",
                min: 0,
                max: 5,
                defaultValue: 3,
                minLabel: "Per niente",
                maxLabel: "Moltissimo",
                weightX: -0.5,
                weightY: -0.5
            },
            {
                type: "slider",
                text: "Non vedo dove sia il problema nell'avere le macchine parcheggiate lungo la strada: è normale così.",
                min: 0,
                max: 5,
                defaultValue: 3,
                minLabel: "Per niente",
                maxLabel: "Moltissimo",
                weightX: -1,
                weightY: -0.5
            },
            {
                type: "slider",
                text: "Dipendo dall'auto per i miei spostamenti: non potrei farne a meno soprattutto con le alternative attuali.",
                min: 0,
                max: 5,
                defaultValue: 3,
                minLabel: "Per niente",
                maxLabel: "Moltissimo",
                weightX: -1,
                weightY: -1
            },
            {
                type: "radio",
                text: "Domanda 8",
                options: [
                    {text: "Risposta 1", value: "8_1"},
                    {text: "Risposta 2", value: "8_2"},
                    {text: "Risposta 3", value: "8_3"}
                ]
            },
        ],

        results: {
            ecologisti_convinti: {
                title: "Ecologisti Convinti",
                description: "Vogliono meno auto, più verde, più transizione. Votano sempre per il cambiamento."
            },
            amici_piazza: {
                title: "Amici della Piazza",
                description: "Amano stare insieme, immaginano piazze vive e verdi come cuore della città."
            },
            abitudinari_volante: {
                title: "Abitudinari al Volante",
                description: " Si trovano bene così: macchina sotto casa, poche novità. Ogni cambiamento è un fastidio."
            },
            verdi_salotto: {
                title: "Verdi da Salotto",
                description: "Vogliono piante e fiori, ma guai a rumore, schiamazzi o rivoluzioni sotto casa."
            },
            pragmatici_sosta: {
                title: "Pragmatici della sosta",
                description: "Temono il traffico e i problemi pratici. Se non c'è parcheggio comodo, si oppongono."
            },
            entusiasti_futuro: {
                title: "Entusiasti del Futuro",
                description: "Vedono la città come un laboratorio vivo, immaginano trasformazioni radicali e le abbracciano."
            },
            cittadini_equilibristi: {
                title: "Cittadini Equilibristi",
                description: "Oscillano. Da un lato capiscono la necessità di cambiare, dall'altro hanno paura di perdere comfort."
            },

        }
    };

    // Initialize the quiz
    function initQuiz() {
        document.getElementById('quizTitle').textContent = quizData.title;
        document.getElementById('quizDescription').textContent = quizData.description;

        const container = document.getElementById('questionsContainer');
        container.innerHTML = '';

        quizData.questions.forEach((question, qIndex) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question';

            const questionText = document.createElement('div');
            questionText.className = 'question-text';
            questionText.textContent = `${qIndex + 1}. ${question.text}`;
            questionDiv.appendChild(questionText);

            if (question.type === 'radio') {
                // Render radio options
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'options';

                question.options.forEach((option, oIndex) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'option';

                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = `question${qIndex}`;
                    radio.value = option.value;
                    radio.id = `q${qIndex}o${oIndex}`;
                    radio.required = true;
                    radio.dataset.text = option.text;

                    const label = document.createElement('label');
                    label.htmlFor = `q${qIndex}o${oIndex}`;
                    label.textContent = option.text;

                    optionDiv.appendChild(radio);
                    optionDiv.appendChild(label);

                    optionDiv.addEventListener('click', function () {
                        radio.checked = true;
                        document.querySelectorAll(`input[name="question${qIndex}"]`).forEach(r => {
                            r.closest('.option').classList.remove('selected');
                        });
                        optionDiv.classList.add('selected');
                    });

                    optionsDiv.appendChild(optionDiv);
                });

                questionDiv.appendChild(optionsDiv);
            } else if (question.type === 'slider') {
                // Render slider
                const sliderContainer = document.createElement('div');
                sliderContainer.className = 'slider-container';

                const sliderWrapper = document.createElement('div');
                sliderWrapper.className = 'slider-wrapper';

                const slider = document.createElement('input');
                slider.type = 'range';
                slider.className = 'slider';
                slider.name = `question${qIndex}`;
                slider.min = question.min || 0;
                slider.max = question.max || 10;
                slider.value = question.defaultValue || Math.floor((question.max + question.min) / 2);
                slider.id = `q${qIndex}slider`;

                const sliderValue = document.createElement('div');
                sliderValue.className = 'slider-value';
                sliderValue.textContent = slider.value;

                slider.addEventListener('input', function () {
                    sliderValue.textContent = this.value;
                });

                sliderWrapper.appendChild(slider);
                sliderWrapper.appendChild(sliderValue);

                const labelsDiv = document.createElement('div');
                labelsDiv.className = 'slider-labels';

                const minLabel = document.createElement('span');
                minLabel.textContent = question.minLabel || question.min;

                const maxLabel = document.createElement('span');
                maxLabel.textContent = question.maxLabel || question.max;

                labelsDiv.appendChild(minLabel);
                labelsDiv.appendChild(maxLabel);

                sliderContainer.appendChild(sliderWrapper);
                sliderContainer.appendChild(labelsDiv);
                questionDiv.appendChild(sliderContainer);
            }

            container.appendChild(questionDiv);
        });
    }

    function calculateResult(answers) {
        console.log("answers", answers);
        const s = [];
        answers.forEach(
            (answer, index) => {
                if (answer.type === 'slider') {
                    s[index] = (answer.value - 2.5) / 2.5
                }
            }
        )

        const weights = [];
        quizData.questions.forEach((question, index) => {
            if (question.type === 'slider') {
                weights[index] = {
                    x: s[index] * question.weightX,
                    y: s[index] * question.weightY,
                }
            }
        })
        console.log(s)
        console.log(weights);
        let sumCx = 0;
        let sumCy = 0;
        let countNonZeroX = 0;
        let countNonZeroY = 0;

        quizData.questions.forEach((question, index) => {
            if (question.type === 'slider') {
                sumCx += weights[index].x;
                sumCy += weights[index].y;

                if (Math.abs(question.weightX) > 0) countNonZeroX++;
                if (Math.abs(question.weightY) > 0) countNonZeroY++;
            }
        });

        const Xbar = sumCx / countNonZeroX;
        const Ybar = sumCy / countNonZeroY;
        const Xpct = 50 * (Xbar + 1);
        const Ypct = 50 * (Ybar + 1);
        console.log("xpct", Xpct);
        console.log("ypct", Ypct);
        let resultKey = 'verdi_salotto';
        console.log("res", quizData.results[resultKey]);
        return {
            timestamp: new Date().toISOString(),
            result: quizData.results[resultKey],
            q1: +answers[0].value,
            q2: +answers[1].value,
            q3: +answers[2].value,
            q4: +answers[3].value,
            q5: +answers[4].value,
            q6: +answers[5].value,
            q7: +answers[6].value,
            x: Xpct,
            y: Ypct,
        }
    }

    // Update the cartesian plane with the calculated coordinates
    function updateCartesianPlane(xPct, yPct) {
        // Convert percentages (0-100) to SVG coordinates (0-500)
        // X: 0% = left (0), 100% = right (500)
        // Y: 0% = bottom (500), 100% = top (0) - inverted because SVG Y grows downward
        const svgX = (xPct / 100) * 500;
        const svgY = 500 - (yPct / 100) * 500; // Invert Y axis

        // Update the point position
        const point = document.getElementById('resultPoint');
        point.setAttribute('cx', svgX);
        point.setAttribute('cy', svgY);

        // Update crosshair lines
        const verticalLine = document.getElementById('verticalLine');
        const horizontalLine = document.getElementById('horizontalLine');
        verticalLine.setAttribute('x1', svgX);
        verticalLine.setAttribute('x2', svgX);
        horizontalLine.setAttribute('y1', svgY);
        horizontalLine.setAttribute('y2', svgY);

        // Update coordinates text
        const coordText = document.getElementById('coordinatesText');
        coordText.textContent = `Posizione: (${Math.round(xPct)}, ${Math.round(yPct)})`;
    }

    // Send data to Google Sheets
    async function sendToGoogleSheets(data) {
        if (!ENABLE_DATA_COLLECTION) {
            console.log('Data collection disabled');
            return true;
        }

        if (GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_SCRIPT_URL_HERE') {
            console.warn('Google Sheets URL not configured');
            return true;
        }

        try {
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            return true;
        } catch (error) {
            console.error('Error sending data:', error);
            return true;
        }
    }

    // Handle form submission
    document.getElementById('quizForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const answers = [];
        const answersSimple = [];

        quizData.questions.forEach((question, index) => {
            if (question.type === 'radio') {
                const selected = document.querySelector(`input[name="question${index}"]:checked`);
                if (selected) {
                    const selectedIndex = Array.from(
                        document.querySelectorAll(`input[name="question${index}"]`)
                    ).indexOf(selected);

                    answers.push({
                        type: 'radio',
                        value: selected.value,
                        text: selected.dataset.text
                    });

                    answersSimple.push(`Q${index + 1}: A${selectedIndex + 1}`);
                }
            } else if (question.type === 'slider') {
                const slider = document.getElementById(`q${index}slider`);
                if (slider) {
                    answers.push({
                        type: 'slider',
                        value: slider.value,
                        text: `${slider.value}`
                    });

                    answersSimple.push(`Q${index + 1}: ${slider.value}`);
                }
            }
        });

        const result = calculateResult(answers);

        // Show loading
        document.getElementById('formSection').classList.add('hidden');
        document.getElementById('loadingSection').classList.add('show');

        // Prepare data for Google Sheets
        const submissionData = {
            timestamp: new Date().toISOString(),
            result: result.result.title,
            q1: result.q1,
            q2: result.q2,
            q3: result.q3,
            q4: result.q4,
            q5: result.q5,
            q6: result.q6,
            q7: result.q7,
            x: result.x,
            y: result.y,
        };
        console.log('Sending to Google Sheets:', submissionData);

        // Show result
        document.getElementById('resultTitle').textContent = result.result.title;
        document.getElementById('resultDescription').textContent = result.result.description;

        // Update cartesian plane with the calculated point
        updateCartesianPlane(result.x, result.y);

        document.getElementById('loadingSection').classList.remove('show');
        document.getElementById('resultSection').classList.add('show');

        // Send to Google Sheets
        await sendToGoogleSheets(submissionData);
    });

    // Restart quiz
    function restartQuiz() {
        document.getElementById('quizForm').reset();
        document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));

        // Reset sliders to default values
        quizData.questions.forEach((question, index) => {
            if (question.type === 'slider') {
                const slider = document.getElementById(`q${index}slider`);
                if (slider) {
                    slider.value = question.defaultValue || Math.floor((question.max + question.min) / 2);
                    const sliderValue = slider.nextElementSibling;
                    if (sliderValue) {
                        sliderValue.textContent = slider.value;
                    }
                }
            }
        });

        document.getElementById('formSection').classList.remove('hidden');
        document.getElementById('resultSection').classList.remove('show');
    }

    // Initialize on page load
    initQuiz();
</script>
</body>
</html>
